<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/storyprinter/StoryModeActivity.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/storyprinter/StoryModeActivity.java" />
              <option name="originalContent" value="package com.example.storyprinter;&#10;&#10;import android.graphics.Bitmap;&#10;import android.graphics.BitmapFactory;&#10;import android.os.Bundle;&#10;import android.os.Handler;&#10;import android.os.Looper;&#10;import android.text.TextUtils;&#10;import android.util.Base64;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import android.widget.Button;&#10;import android.widget.EditText;&#10;import android.widget.ImageView;&#10;import android.widget.LinearLayout;&#10;import android.widget.ProgressBar;&#10;import android.widget.TextView;&#10;&#10;import androidx.activity.EdgeToEdge;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;import androidx.core.graphics.Insets;&#10;import androidx.core.view.ViewCompat;&#10;import androidx.core.view.WindowInsetsCompat;&#10;&#10;import com.example.storyprinter.openai.ChatMessage;&#10;import com.example.storyprinter.openai.OpenAiClient;&#10;&#10;import java.io.IOException;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;import java.util.concurrent.ExecutorService;&#10;import java.util.concurrent.Executors;&#10;&#10;import okhttp3.OkHttpClient;&#10;&#10;public class StoryModeActivity extends AppCompatActivity {&#10;&#10;    // Loaded from BuildConfig.OPENAI_API_KEY (configured via local.properties, not version-controlled).&#10;    private static final String OPENAI_API_KEY = com.example.storyprinter.BuildConfig.OPENAI_API_KEY;&#10;&#10;    private static final String MODEL = &quot;gpt-4.1-mini&quot;;&#10;    private static final double TEMPERATURE = 1.1; // relatively high for imagination&#10;    private static final String IMAGE_MODEL = &quot;gpt-5&quot;;&#10;&#10;    private EditText etSeed;&#10;    private Button btnStart;&#10;    private Button btnNext;&#10;    private TextView tvOutput;&#10;    private ProgressBar progress;&#10;&#10;    // Container that will hold full page blocks (title + text + image)&#10;    private LinearLayout pagesContainer;&#10;&#10;    private final ExecutorService io = Executors.newSingleThreadExecutor();&#10;    private final Handler main = new Handler(Looper.getMainLooper());&#10;&#10;    private OpenAiClient openAi;&#10;    private OpenAiClient openAiImages;&#10;    private final List&lt;ChatMessage&gt; conversation = new ArrayList&lt;&gt;();&#10;&#10;    private int pageIndex = 0;&#10;&#10;    // Responses API conversation chaining.&#10;    private String previousTextResponseId = null;&#10;    private String previousImageResponseId = null;&#10;&#10;    private String seedPrompt = null;&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        EdgeToEdge.enable(this);&#10;        setContentView(R.layout.activity_story_mode);&#10;        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main_story), (v, insets) -&gt; {&#10;            Insets systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars());&#10;            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom);&#10;            return insets;&#10;        });&#10;&#10;        etSeed = findViewById(R.id.etSeed);&#10;        btnStart = findViewById(R.id.btnStart);&#10;        btnNext = findViewById(R.id.btnNext);&#10;        tvOutput = findViewById(R.id.tvOutput);&#10;        progress = findViewById(R.id.progress);&#10;        pagesContainer = findViewById(R.id.pagesContainer);&#10;&#10;        // tvOutput is no longer used for status; keep it hidden (or we can remove it from layout later).&#10;        if (tvOutput != null) {&#10;            tvOutput.setVisibility(View.GONE);&#10;        }&#10;        // Use only per-page spinners.&#10;        if (progress != null) {&#10;            progress.setVisibility(View.GONE);&#10;        }&#10;&#10;        // Text calls: default timeouts.&#10;        OkHttpClient textHttp = new OkHttpClient();&#10;&#10;        // Image calls can take longer: bump call/read/write timeouts.&#10;        OkHttpClient imageHttp = new OkHttpClient.Builder()&#10;                .callTimeout(java.time.Duration.ofSeconds(120))&#10;                .connectTimeout(java.time.Duration.ofSeconds(30))&#10;                .readTimeout(java.time.Duration.ofSeconds(120))&#10;                .writeTimeout(java.time.Duration.ofSeconds(120))&#10;                .build();&#10;&#10;        openAi = new OpenAiClient(textHttp, OPENAI_API_KEY);&#10;        openAiImages = new OpenAiClient(imageHttp, OPENAI_API_KEY);&#10;&#10;        btnStart.setOnClickListener(v -&gt; startStory());&#10;        btnNext.setOnClickListener(v -&gt; nextPage());&#10;&#10;        if (savedInstanceState != null) {&#10;            // Minimal state restore for rotation.&#10;            etSeed.setText(savedInstanceState.getString(&quot;seed&quot;, &quot;&quot;));&#10;            pageIndex = savedInstanceState.getInt(&quot;pageIndex&quot;, 0);&#10;            boolean started = savedInstanceState.getBoolean(&quot;started&quot;, false);&#10;            btnNext.setEnabled(started);&#10;            previousTextResponseId = savedInstanceState.getString(&quot;previousTextResponseId&quot;, null);&#10;            previousImageResponseId = savedInstanceState.getString(&quot;previousImageResponseId&quot;, null);&#10;            seedPrompt = savedInstanceState.getString(&quot;seedPrompt&quot;, null);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    protected void onSaveInstanceState(Bundle outState) {&#10;        super.onSaveInstanceState(outState);&#10;        outState.putString(&quot;seed&quot;, etSeed.getText() != null ? etSeed.getText().toString() : &quot;&quot;);&#10;        outState.putInt(&quot;pageIndex&quot;, pageIndex);&#10;        outState.putBoolean(&quot;started&quot;, btnNext.isEnabled());&#10;        outState.putString(&quot;previousTextResponseId&quot;, previousTextResponseId);&#10;        outState.putString(&quot;previousImageResponseId&quot;, previousImageResponseId);&#10;        outState.putString(&quot;seedPrompt&quot;, seedPrompt);&#10;    }&#10;&#10;    @Override&#10;    protected void onDestroy() {&#10;        super.onDestroy();&#10;        io.shutdownNow();&#10;    }&#10;&#10;    private void startStory() {&#10;        String seed = etSeed.getText() != null ? etSeed.getText().toString().trim() : &quot;&quot;;&#10;        if (TextUtils.isEmpty(seed)) {&#10;            etSeed.setError(&quot;Please enter a seed prompt&quot;);&#10;            return;&#10;        }&#10;&#10;        seedPrompt = seed;&#10;&#10;        conversation.clear();&#10;        pageIndex = 0;&#10;        previousTextResponseId = null;&#10;        previousImageResponseId = null;&#10;&#10;        // Starting a new story should reset pages (including images).&#10;        pagesContainer.removeAllViews();&#10;&#10;        // Hide global status views.&#10;        if (tvOutput != null) tvOutput.setVisibility(View.GONE);&#10;        if (progress != null) progress.setVisibility(View.GONE);&#10;&#10;        btnNext.setEnabled(false);&#10;        btnStart.setEnabled(false);&#10;&#10;        queryAndAppendAssistantMessage();&#10;    }&#10;&#10;    private void nextPage() {&#10;        conversation.add(new ChatMessage(&quot;user&quot;, &quot;Generate the image description for Page &quot; + (pageIndex + 1) + &quot;.&quot;));&#10;        btnNext.setEnabled(false);&#10;        btnStart.setEnabled(false);&#10;        queryAndAppendAssistantMessage();&#10;    }&#10;&#10;    private void queryAndAppendAssistantMessage() {&#10;        // No global spinner; per-page spinner will be shown under the new page block.&#10;&#10;        io.execute(() -&gt; {&#10;            final int pageNumberToRender = pageIndex + 1;&#10;            final LinearLayout[] pageBlockHolder = new LinearLayout[1];&#10;            main.post(() -&gt; {&#10;                LinearLayout pageBlock = createPageBlock(pageNumberToRender);&#10;                pagesContainer.addView(pageBlock);&#10;                setPageImageLoading(pageBlock, true);&#10;                pageBlockHolder[0] = pageBlock;&#10;            });&#10;&#10;            try {&#10;                String input;&#10;                if (previousTextResponseId == null) {&#10;                    input = &quot;You create page-by-page prompts for a children's picture book. &quot; +&#10;                            &quot;Return ONLY a simple, vivid image description for one page (no title, no extra commentary). &quot; +&#10;                            &quot;Keep it child-friendly, concrete, and easy to illustrate. 1 short paragraph max.\n\n&quot; +&#10;                            &quot;Story seed: &quot; + (seedPrompt != null ? seedPrompt : &quot;&quot;) + &quot;\n&quot; +&#10;                            &quot;Generate the image description for Page 1.&quot;;&#10;                } else {&#10;                    input = &quot;Generate the image description for Page &quot; + pageNumberToRender + &quot;.&quot;;&#10;                }&#10;&#10;                OpenAiClient.ResponseResult result = openAi.createResponse(&#10;                        MODEL,&#10;                        TEMPERATURE,&#10;                        input,&#10;                        previousTextResponseId&#10;                );&#10;&#10;                if (result.responseId != null &amp;&amp; !result.responseId.trim().isEmpty()) {&#10;                    previousTextResponseId = result.responseId;&#10;                }&#10;&#10;                String assistant = result.outputText;&#10;                conversation.add(new ChatMessage(&quot;assistant&quot;, assistant));&#10;&#10;                main.post(() -&gt; {&#10;                    pageIndex = pageNumberToRender;&#10;                    LinearLayout pageBlock = pageBlockHolder[0];&#10;                    if (pageBlock != null) {&#10;                        setPageText(pageBlock, assistant);&#10;                    }&#10;                });&#10;&#10;                OpenAiClient.ImageResult imageResult = openAiImages.generateImage(&#10;                        IMAGE_MODEL,&#10;                        assistant,&#10;                        previousImageResponseId&#10;                );&#10;&#10;                if (imageResult.responseId != null &amp;&amp; !imageResult.responseId.trim().isEmpty()) {&#10;                    previousImageResponseId = imageResult.responseId;&#10;                }&#10;&#10;                Bitmap bitmap = decodeBase64ToBitmap(imageResult.imageBase64);&#10;&#10;                main.post(() -&gt; {&#10;                    LinearLayout pageBlock = pageBlockHolder[0];&#10;                    if (pageBlock != null) {&#10;                        setPageImageLoading(pageBlock, false);&#10;                        if (bitmap != null) {&#10;                            setPageImage(pageBlock, bitmap, pageNumberToRender);&#10;                        } else {&#10;                            setPageError(pageBlock, &quot;No image returned.&quot;);&#10;                        }&#10;                    }&#10;&#10;                    btnNext.setEnabled(true);&#10;                    btnStart.setEnabled(true);&#10;                });&#10;            } catch (IOException e) {&#10;                main.post(() -&gt; {&#10;                    LinearLayout pageBlock = pageBlockHolder[0];&#10;                    if (pageBlock != null) {&#10;                        setPageImageLoading(pageBlock, false);&#10;                        setPageError(pageBlock, (e.getMessage() != null ? e.getMessage() : e.toString()));&#10;                    }&#10;                    btnStart.setEnabled(true);&#10;                    btnNext.setEnabled(pageIndex &gt; 0);&#10;                });&#10;            }&#10;        });&#10;    }&#10;&#10;    private LinearLayout createPageBlock(int pageNumber) {&#10;        LinearLayout block = new LinearLayout(this);&#10;        block.setOrientation(LinearLayout.VERTICAL);&#10;        block.setLayoutParams(new LinearLayout.LayoutParams(&#10;                ViewGroup.LayoutParams.MATCH_PARENT,&#10;                ViewGroup.LayoutParams.WRAP_CONTENT&#10;        ));&#10;&#10;        LinearLayout.LayoutParams blockLp = (LinearLayout.LayoutParams) block.getLayoutParams();&#10;        blockLp.topMargin = dpToPx(16);&#10;        block.setLayoutParams(blockLp);&#10;&#10;        TextView title = new TextView(this);&#10;        title.setLayoutParams(new LinearLayout.LayoutParams(&#10;                ViewGroup.LayoutParams.MATCH_PARENT,&#10;                ViewGroup.LayoutParams.WRAP_CONTENT&#10;        ));&#10;        title.setText(&quot;Page &quot; + pageNumber);&#10;        title.setTextSize(18);&#10;        title.setTypeface(title.getTypeface(), android.graphics.Typeface.BOLD);&#10;        title.setTag(&quot;pageTitle&quot;);&#10;&#10;        TextView text = new TextView(this);&#10;        text.setLayoutParams(new LinearLayout.LayoutParams(&#10;                ViewGroup.LayoutParams.MATCH_PARENT,&#10;                ViewGroup.LayoutParams.WRAP_CONTENT&#10;        ));&#10;        LinearLayout.LayoutParams textLp = (LinearLayout.LayoutParams) text.getLayoutParams();&#10;        textLp.topMargin = dpToPx(6);&#10;        text.setLayoutParams(textLp);&#10;        text.setText(&quot;&quot;);&#10;        text.setTag(&quot;pageText&quot;);&#10;&#10;        TextView error = new TextView(this);&#10;        error.setLayoutParams(new LinearLayout.LayoutParams(&#10;                ViewGroup.LayoutParams.MATCH_PARENT,&#10;                ViewGroup.LayoutParams.WRAP_CONTENT&#10;        ));&#10;        LinearLayout.LayoutParams errLp = (LinearLayout.LayoutParams) error.getLayoutParams();&#10;        errLp.topMargin = dpToPx(8);&#10;        error.setLayoutParams(errLp);&#10;        error.setVisibility(View.GONE);&#10;        error.setTag(&quot;pageError&quot;);&#10;&#10;        ProgressBar imageProgress = new ProgressBar(this);&#10;        imageProgress.setIndeterminate(true);&#10;        LinearLayout.LayoutParams pbLp = new LinearLayout.LayoutParams(&#10;                ViewGroup.LayoutParams.WRAP_CONTENT,&#10;                ViewGroup.LayoutParams.WRAP_CONTENT&#10;        );&#10;        pbLp.topMargin = dpToPx(10);&#10;        pbLp.gravity = android.view.Gravity.CENTER_HORIZONTAL;&#10;        imageProgress.setLayoutParams(pbLp);&#10;        imageProgress.setTag(&quot;imageProgress&quot;);&#10;        imageProgress.setVisibility(View.GONE);&#10;&#10;        ImageView image = new ImageView(this);&#10;        image.setLayoutParams(new LinearLayout.LayoutParams(&#10;                ViewGroup.LayoutParams.MATCH_PARENT,&#10;                ViewGroup.LayoutParams.WRAP_CONTENT&#10;        ));&#10;        LinearLayout.LayoutParams imgLp = (LinearLayout.LayoutParams) image.getLayoutParams();&#10;        imgLp.topMargin = dpToPx(10);&#10;        image.setLayoutParams(imgLp);&#10;        image.setAdjustViewBounds(true);&#10;        image.setScaleType(ImageView.ScaleType.FIT_CENTER);&#10;        image.setVisibility(View.GONE);&#10;        image.setTag(&quot;pageImage&quot;);&#10;&#10;        block.addView(title);&#10;        block.addView(text);&#10;        block.addView(error);&#10;        block.addView(imageProgress);&#10;        block.addView(image);&#10;        return block;&#10;    }&#10;&#10;    private void setPageText(LinearLayout pageBlock, String text) {&#10;        if (pageBlock == null) return;&#10;        View t = pageBlock.findViewWithTag(&quot;pageText&quot;);&#10;        if (t instanceof TextView) {&#10;            ((TextView) t).setText(text != null ? text : &quot;&quot;);&#10;        }&#10;    }&#10;&#10;    private void setPageError(LinearLayout pageBlock, String errorText) {&#10;        if (pageBlock == null) return;&#10;        View e = pageBlock.findViewWithTag(&quot;pageError&quot;);&#10;        if (e instanceof TextView) {&#10;            TextView tv = (TextView) e;&#10;            tv.setText(errorText != null ? errorText : &quot;Unknown error&quot;);&#10;            tv.setVisibility(View.VISIBLE);&#10;        }&#10;    }&#10;&#10;    private void setPageImageLoading(LinearLayout pageBlock, boolean loading) {&#10;        if (pageBlock == null) return;&#10;        View pb = pageBlock.findViewWithTag(&quot;imageProgress&quot;);&#10;        if (pb != null) {&#10;            pb.setVisibility(loading ? View.VISIBLE : View.GONE);&#10;        }&#10;    }&#10;&#10;    private void setPageImage(LinearLayout pageBlock, Bitmap bitmap, int pageNumber) {&#10;        if (pageBlock == null || bitmap == null) return;&#10;        View v = pageBlock.findViewWithTag(&quot;pageImage&quot;);&#10;        if (!(v instanceof ImageView)) return;&#10;&#10;        ImageView iv = (ImageView) v;&#10;        iv.setAdjustViewBounds(true);&#10;        iv.setScaleType(ImageView.ScaleType.FIT_CENTER);&#10;        iv.setContentDescription(&quot;Generated story image for page &quot; + pageNumber);&#10;        iv.setImageBitmap(bitmap);&#10;        iv.setVisibility(View.VISIBLE);&#10;    }&#10;&#10;    private int dpToPx(int dp) {&#10;        float density = getResources().getDisplayMetrics().density;&#10;        return Math.round(dp * density);&#10;    }&#10;&#10;&#10;    private static Bitmap decodeBase64ToBitmap(String base64) {&#10;        if (base64 == null || base64.trim().isEmpty()) return null;&#10;        try {&#10;            byte[] bytes = Base64.decode(base64, Base64.DEFAULT);&#10;            return BitmapFactory.decodeByteArray(bytes, 0, bytes.length);&#10;        } catch (IllegalArgumentException e) {&#10;            return null;&#10;        }&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.storyprinter;&#10;&#10;import android.graphics.Bitmap;&#10;import android.graphics.BitmapFactory;&#10;import android.os.Bundle;&#10;import android.os.Handler;&#10;import android.os.Looper;&#10;import android.text.TextUtils;&#10;import android.util.Base64;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import android.widget.Button;&#10;import android.widget.EditText;&#10;import android.widget.ImageView;&#10;import android.widget.LinearLayout;&#10;import android.widget.ProgressBar;&#10;import android.widget.TextView;&#10;&#10;import androidx.activity.EdgeToEdge;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;import androidx.core.graphics.Insets;&#10;import androidx.core.view.ViewCompat;&#10;import androidx.core.view.WindowInsetsCompat;&#10;&#10;import com.example.storyprinter.openai.ChatMessage;&#10;import com.example.storyprinter.openai.OpenAiClient;&#10;&#10;import java.io.IOException;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;import java.util.concurrent.ExecutorService;&#10;import java.util.concurrent.Executors;&#10;&#10;import okhttp3.OkHttpClient;&#10;&#10;public class StoryModeActivity extends AppCompatActivity {&#10;&#10;    // Loaded from BuildConfig.OPENAI_API_KEY (configured via local.properties, not version-controlled).&#10;    private static final String OPENAI_API_KEY = com.example.storyprinter.BuildConfig.OPENAI_API_KEY;&#10;&#10;    private static final String MODEL = &quot;gpt-4.1-mini&quot;;&#10;    private static final double TEMPERATURE = 1.1; // relatively high for imagination&#10;    private static final String IMAGE_MODEL = &quot;gpt-5&quot;;&#10;&#10;    private EditText etSeed;&#10;    private Button btnStart;&#10;    private Button btnNext;&#10;&#10;    // Container that will hold full page blocks (title + text + image)&#10;    private LinearLayout pagesContainer;&#10;&#10;    private final ExecutorService io = Executors.newSingleThreadExecutor();&#10;    private final Handler main = new Handler(Looper.getMainLooper());&#10;&#10;    private OpenAiClient openAi;&#10;    private OpenAiClient openAiImages;&#10;    private final List&lt;ChatMessage&gt; conversation = new ArrayList&lt;&gt;();&#10;&#10;    private int pageIndex = 0;&#10;&#10;    // Responses API conversation chaining.&#10;    private String previousTextResponseId = null;&#10;    private String previousImageResponseId = null;&#10;&#10;    private String seedPrompt = null;&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        EdgeToEdge.enable(this);&#10;        setContentView(R.layout.activity_story_mode);&#10;        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main_story), (v, insets) -&gt; {&#10;            Insets systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars());&#10;            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom);&#10;            return insets;&#10;        });&#10;&#10;        etSeed = findViewById(R.id.etSeed);&#10;        btnStart = findViewById(R.id.btnStart);&#10;        btnNext = findViewById(R.id.btnNext);&#10;        pagesContainer = findViewById(R.id.pagesContainer);&#10;&#10;        // Text calls: default timeouts.&#10;        OkHttpClient textHttp = new OkHttpClient();&#10;&#10;        // Image calls can take longer: bump call/read/write timeouts.&#10;        OkHttpClient imageHttp = new OkHttpClient.Builder()&#10;                .callTimeout(java.time.Duration.ofSeconds(120))&#10;                .connectTimeout(java.time.Duration.ofSeconds(30))&#10;                .readTimeout(java.time.Duration.ofSeconds(120))&#10;                .writeTimeout(java.time.Duration.ofSeconds(120))&#10;                .build();&#10;&#10;        openAi = new OpenAiClient(textHttp, OPENAI_API_KEY);&#10;        openAiImages = new OpenAiClient(imageHttp, OPENAI_API_KEY);&#10;&#10;        btnStart.setOnClickListener(v -&gt; startStory());&#10;        btnNext.setOnClickListener(v -&gt; nextPage());&#10;&#10;        if (savedInstanceState != null) {&#10;            // Minimal state restore for rotation.&#10;            etSeed.setText(savedInstanceState.getString(&quot;seed&quot;, &quot;&quot;));&#10;            pageIndex = savedInstanceState.getInt(&quot;pageIndex&quot;, 0);&#10;            boolean started = savedInstanceState.getBoolean(&quot;started&quot;, false);&#10;            btnNext.setEnabled(started);&#10;            previousTextResponseId = savedInstanceState.getString(&quot;previousTextResponseId&quot;, null);&#10;            previousImageResponseId = savedInstanceState.getString(&quot;previousImageResponseId&quot;, null);&#10;            seedPrompt = savedInstanceState.getString(&quot;seedPrompt&quot;, null);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    protected void onSaveInstanceState(Bundle outState) {&#10;        super.onSaveInstanceState(outState);&#10;        outState.putString(&quot;seed&quot;, etSeed.getText() != null ? etSeed.getText().toString() : &quot;&quot;);&#10;        outState.putInt(&quot;pageIndex&quot;, pageIndex);&#10;        outState.putBoolean(&quot;started&quot;, btnNext.isEnabled());&#10;        outState.putString(&quot;previousTextResponseId&quot;, previousTextResponseId);&#10;        outState.putString(&quot;previousImageResponseId&quot;, previousImageResponseId);&#10;        outState.putString(&quot;seedPrompt&quot;, seedPrompt);&#10;    }&#10;&#10;    @Override&#10;    protected void onDestroy() {&#10;        super.onDestroy();&#10;        io.shutdownNow();&#10;    }&#10;&#10;    private void startStory() {&#10;        String seed = etSeed.getText() != null ? etSeed.getText().toString().trim() : &quot;&quot;;&#10;        if (TextUtils.isEmpty(seed)) {&#10;            etSeed.setError(&quot;Please enter a seed prompt&quot;);&#10;            return;&#10;        }&#10;&#10;        seedPrompt = seed;&#10;&#10;        conversation.clear();&#10;        pageIndex = 0;&#10;        previousTextResponseId = null;&#10;        previousImageResponseId = null;&#10;&#10;        // Starting a new story should reset pages (including images).&#10;        pagesContainer.removeAllViews();&#10;&#10;        btnNext.setEnabled(false);&#10;        btnStart.setEnabled(false);&#10;&#10;        queryAndAppendAssistantMessage();&#10;    }&#10;&#10;    private void nextPage() {&#10;        conversation.add(new ChatMessage(&quot;user&quot;, &quot;Generate the image description for Page &quot; + (pageIndex + 1) + &quot;.&quot;));&#10;        btnNext.setEnabled(false);&#10;        btnStart.setEnabled(false);&#10;        queryAndAppendAssistantMessage();&#10;    }&#10;&#10;    private void queryAndAppendAssistantMessage() {&#10;        // No global spinner; per-page spinner will be shown under the new page block.&#10;&#10;        io.execute(() -&gt; {&#10;            final int pageNumberToRender = pageIndex + 1;&#10;            final LinearLayout[] pageBlockHolder = new LinearLayout[1];&#10;            main.post(() -&gt; {&#10;                LinearLayout pageBlock = createPageBlock(pageNumberToRender);&#10;                pagesContainer.addView(pageBlock);&#10;                setPageImageLoading(pageBlock, true);&#10;                pageBlockHolder[0] = pageBlock;&#10;            });&#10;&#10;            try {&#10;                String input;&#10;                if (previousTextResponseId == null) {&#10;                    input = &quot;You create page-by-page prompts for a children's picture book. &quot; +&#10;                            &quot;Return ONLY a simple, vivid image description for one page (no title, no extra commentary). &quot; +&#10;                            &quot;Keep it child-friendly, concrete, and easy to illustrate. 1 short paragraph max.\n\n&quot; +&#10;                            &quot;Story seed: &quot; + (seedPrompt != null ? seedPrompt : &quot;&quot;) + &quot;\n&quot; +&#10;                            &quot;Generate the image description for Page 1.&quot;;&#10;                } else {&#10;                    input = &quot;Generate the image description for Page &quot; + pageNumberToRender + &quot;.&quot;;&#10;                }&#10;&#10;                OpenAiClient.ResponseResult result = openAi.createResponse(&#10;                        MODEL,&#10;                        TEMPERATURE,&#10;                        input,&#10;                        previousTextResponseId&#10;                );&#10;&#10;                if (result.responseId != null &amp;&amp; !result.responseId.trim().isEmpty()) {&#10;                    previousTextResponseId = result.responseId;&#10;                }&#10;&#10;                String assistant = result.outputText;&#10;                conversation.add(new ChatMessage(&quot;assistant&quot;, assistant));&#10;&#10;                main.post(() -&gt; {&#10;                    pageIndex = pageNumberToRender;&#10;                    LinearLayout pageBlock = pageBlockHolder[0];&#10;                    if (pageBlock != null) {&#10;                        setPageText(pageBlock, assistant);&#10;                    }&#10;                });&#10;&#10;                OpenAiClient.ImageResult imageResult = openAiImages.generateImage(&#10;                        IMAGE_MODEL,&#10;                        assistant,&#10;                        previousImageResponseId&#10;                );&#10;&#10;                if (imageResult.responseId != null &amp;&amp; !imageResult.responseId.trim().isEmpty()) {&#10;                    previousImageResponseId = imageResult.responseId;&#10;                }&#10;&#10;                Bitmap bitmap = decodeBase64ToBitmap(imageResult.imageBase64);&#10;&#10;                main.post(() -&gt; {&#10;                    LinearLayout pageBlock = pageBlockHolder[0];&#10;                    if (pageBlock != null) {&#10;                        setPageImageLoading(pageBlock, false);&#10;                        if (bitmap != null) {&#10;                            setPageImage(pageBlock, bitmap, pageNumberToRender);&#10;                        } else {&#10;                            setPageError(pageBlock, &quot;No image returned.&quot;);&#10;                        }&#10;                    }&#10;&#10;                    btnNext.setEnabled(true);&#10;                    btnStart.setEnabled(true);&#10;                });&#10;            } catch (IOException e) {&#10;                main.post(() -&gt; {&#10;                    LinearLayout pageBlock = pageBlockHolder[0];&#10;                    if (pageBlock != null) {&#10;                        setPageImageLoading(pageBlock, false);&#10;                        setPageError(pageBlock, (e.getMessage() != null ? e.getMessage() : e.toString()));&#10;                    }&#10;                    btnStart.setEnabled(true);&#10;                    btnNext.setEnabled(pageIndex &gt; 0);&#10;                });&#10;            }&#10;        });&#10;    }&#10;&#10;    private LinearLayout createPageBlock(int pageNumber) {&#10;        LinearLayout block = new LinearLayout(this);&#10;        block.setOrientation(LinearLayout.VERTICAL);&#10;        block.setLayoutParams(new LinearLayout.LayoutParams(&#10;                ViewGroup.LayoutParams.MATCH_PARENT,&#10;                ViewGroup.LayoutParams.WRAP_CONTENT&#10;        ));&#10;&#10;        LinearLayout.LayoutParams blockLp = (LinearLayout.LayoutParams) block.getLayoutParams();&#10;        blockLp.topMargin = dpToPx(16);&#10;        block.setLayoutParams(blockLp);&#10;&#10;        TextView title = new TextView(this);&#10;        title.setLayoutParams(new LinearLayout.LayoutParams(&#10;                ViewGroup.LayoutParams.MATCH_PARENT,&#10;                ViewGroup.LayoutParams.WRAP_CONTENT&#10;        ));&#10;        title.setText(&quot;Page &quot; + pageNumber);&#10;        title.setTextSize(18);&#10;        title.setTypeface(title.getTypeface(), android.graphics.Typeface.BOLD);&#10;        title.setTag(&quot;pageTitle&quot;);&#10;&#10;        TextView text = new TextView(this);&#10;        text.setLayoutParams(new LinearLayout.LayoutParams(&#10;                ViewGroup.LayoutParams.MATCH_PARENT,&#10;                ViewGroup.LayoutParams.WRAP_CONTENT&#10;        ));&#10;        LinearLayout.LayoutParams textLp = (LinearLayout.LayoutParams) text.getLayoutParams();&#10;        textLp.topMargin = dpToPx(6);&#10;        text.setLayoutParams(textLp);&#10;        text.setText(&quot;&quot;);&#10;        text.setTag(&quot;pageText&quot;);&#10;&#10;        TextView error = new TextView(this);&#10;        error.setLayoutParams(new LinearLayout.LayoutParams(&#10;                ViewGroup.LayoutParams.MATCH_PARENT,&#10;                ViewGroup.LayoutParams.WRAP_CONTENT&#10;        ));&#10;        LinearLayout.LayoutParams errLp = (LinearLayout.LayoutParams) error.getLayoutParams();&#10;        errLp.topMargin = dpToPx(8);&#10;        error.setLayoutParams(errLp);&#10;        error.setVisibility(View.GONE);&#10;        error.setTag(&quot;pageError&quot;);&#10;&#10;        ProgressBar imageProgress = new ProgressBar(this);&#10;        imageProgress.setIndeterminate(true);&#10;        LinearLayout.LayoutParams pbLp = new LinearLayout.LayoutParams(&#10;                ViewGroup.LayoutParams.WRAP_CONTENT,&#10;                ViewGroup.LayoutParams.WRAP_CONTENT&#10;        );&#10;        pbLp.topMargin = dpToPx(10);&#10;        pbLp.gravity = android.view.Gravity.CENTER_HORIZONTAL;&#10;        imageProgress.setLayoutParams(pbLp);&#10;        imageProgress.setTag(&quot;imageProgress&quot;);&#10;        imageProgress.setVisibility(View.GONE);&#10;&#10;        ImageView image = new ImageView(this);&#10;        image.setLayoutParams(new LinearLayout.LayoutParams(&#10;                ViewGroup.LayoutParams.MATCH_PARENT,&#10;                ViewGroup.LayoutParams.WRAP_CONTENT&#10;        ));&#10;        LinearLayout.LayoutParams imgLp = (LinearLayout.LayoutParams) image.getLayoutParams();&#10;        imgLp.topMargin = dpToPx(10);&#10;        image.setLayoutParams(imgLp);&#10;        image.setAdjustViewBounds(true);&#10;        image.setScaleType(ImageView.ScaleType.FIT_CENTER);&#10;        image.setVisibility(View.GONE);&#10;        image.setTag(&quot;pageImage&quot;);&#10;&#10;        block.addView(title);&#10;        block.addView(text);&#10;        block.addView(error);&#10;        block.addView(imageProgress);&#10;        block.addView(image);&#10;        return block;&#10;    }&#10;&#10;    private void setPageText(LinearLayout pageBlock, String text) {&#10;        if (pageBlock == null) return;&#10;        View t = pageBlock.findViewWithTag(&quot;pageText&quot;);&#10;        if (t instanceof TextView) {&#10;            ((TextView) t).setText(text != null ? text : &quot;&quot;);&#10;        }&#10;    }&#10;&#10;    private void setPageError(LinearLayout pageBlock, String errorText) {&#10;        if (pageBlock == null) return;&#10;        View e = pageBlock.findViewWithTag(&quot;pageError&quot;);&#10;        if (e instanceof TextView) {&#10;            TextView tv = (TextView) e;&#10;            tv.setText(errorText != null ? errorText : &quot;Unknown error&quot;);&#10;            tv.setVisibility(View.VISIBLE);&#10;        }&#10;    }&#10;&#10;    private void setPageImageLoading(LinearLayout pageBlock, boolean loading) {&#10;        if (pageBlock == null) return;&#10;        View pb = pageBlock.findViewWithTag(&quot;imageProgress&quot;);&#10;        if (pb != null) {&#10;            pb.setVisibility(loading ? View.VISIBLE : View.GONE);&#10;        }&#10;    }&#10;&#10;    private void setPageImage(LinearLayout pageBlock, Bitmap bitmap, int pageNumber) {&#10;        if (pageBlock == null || bitmap == null) return;&#10;        View v = pageBlock.findViewWithTag(&quot;pageImage&quot;);&#10;        if (!(v instanceof ImageView)) return;&#10;&#10;        ImageView iv = (ImageView) v;&#10;        iv.setAdjustViewBounds(true);&#10;        iv.setScaleType(ImageView.ScaleType.FIT_CENTER);&#10;        iv.setContentDescription(&quot;Generated story image for page &quot; + pageNumber);&#10;        iv.setImageBitmap(bitmap);&#10;        iv.setVisibility(View.VISIBLE);&#10;    }&#10;&#10;    private int dpToPx(int dp) {&#10;        float density = getResources().getDisplayMetrics().density;&#10;        return Math.round(dp * density);&#10;    }&#10;&#10;&#10;    private static Bitmap decodeBase64ToBitmap(String base64) {&#10;        if (base64 == null || base64.trim().isEmpty()) return null;&#10;        try {&#10;            byte[] bytes = Base64.decode(base64, Base64.DEFAULT);&#10;            return BitmapFactory.decodeByteArray(bytes, 0, bytes.length);&#10;        } catch (IllegalArgumentException e) {&#10;            return null;&#10;        }&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/res/layout/activity_story_mode.xml">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/res/layout/activity_story_mode.xml" />
              <option name="originalContent" value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#10;&lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&#10;    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;&#10;    xmlns:tools=&quot;http://schemas.android.com/tools&quot;&#10;    android:id=&quot;@+id/main_story&quot;&#10;    android:layout_width=&quot;match_parent&quot;&#10;    android:layout_height=&quot;match_parent&quot;&#10;    android:padding=&quot;24dp&quot;&#10;    tools:context=&quot;.StoryModeActivity&quot;&gt;&#10;&#10;    &lt;TextView&#10;        android:id=&quot;@+id/titleStory&quot;&#10;        android:layout_width=&quot;0dp&quot;&#10;        android:layout_height=&quot;wrap_content&quot;&#10;        android:text=&quot;Story mode&quot;&#10;        android:textStyle=&quot;bold&quot;&#10;        android:textSize=&quot;20sp&quot;&#10;        app:layout_constraintTop_toTopOf=&quot;parent&quot;&#10;        app:layout_constraintStart_toStartOf=&quot;parent&quot;&#10;        app:layout_constraintEnd_toEndOf=&quot;parent&quot; /&gt;&#10;&#10;    &lt;EditText&#10;        android:id=&quot;@+id/etSeed&quot;&#10;        android:layout_width=&quot;0dp&quot;&#10;        android:layout_height=&quot;wrap_content&quot;&#10;        android:hint=&quot;Seed prompt (e.g., 'A brave bunny in space')&quot;&#10;        android:inputType=&quot;textCapSentences|textMultiLine&quot;&#10;        android:minLines=&quot;2&quot;&#10;        android:maxLines=&quot;4&quot;&#10;        app:layout_constraintTop_toBottomOf=&quot;@id/titleStory&quot;&#10;        app:layout_constraintStart_toStartOf=&quot;parent&quot;&#10;        app:layout_constraintEnd_toEndOf=&quot;parent&quot;&#10;        android:layout_marginTop=&quot;12dp&quot; /&gt;&#10;&#10;    &lt;LinearLayout&#10;        android:id=&quot;@+id/rowButtons&quot;&#10;        android:layout_width=&quot;0dp&quot;&#10;        android:layout_height=&quot;wrap_content&quot;&#10;        android:orientation=&quot;horizontal&quot;&#10;        app:layout_constraintTop_toBottomOf=&quot;@id/etSeed&quot;&#10;        app:layout_constraintStart_toStartOf=&quot;parent&quot;&#10;        app:layout_constraintEnd_toEndOf=&quot;parent&quot;&#10;        android:layout_marginTop=&quot;12dp&quot;&gt;&#10;&#10;        &lt;Button&#10;            android:id=&quot;@+id/btnStart&quot;&#10;            android:layout_width=&quot;0dp&quot;&#10;            android:layout_height=&quot;wrap_content&quot;&#10;            android:layout_weight=&quot;1&quot;&#10;            android:text=&quot;Start&quot; /&gt;&#10;&#10;        &lt;Button&#10;            android:id=&quot;@+id/btnNext&quot;&#10;            android:layout_width=&quot;0dp&quot;&#10;            android:layout_height=&quot;wrap_content&quot;&#10;            android:layout_weight=&quot;1&quot;&#10;            android:text=&quot;Next&quot;&#10;            android:enabled=&quot;false&quot;&#10;            android:layout_marginStart=&quot;12dp&quot; /&gt;&#10;&#10;    &lt;/LinearLayout&gt;&#10;&#10;    &lt;ProgressBar&#10;        android:id=&quot;@+id/progress&quot;&#10;        style=&quot;?android:attr/progressBarStyle&quot;&#10;        android:layout_width=&quot;wrap_content&quot;&#10;        android:layout_height=&quot;wrap_content&quot;&#10;        android:visibility=&quot;gone&quot;&#10;        app:layout_constraintTop_toBottomOf=&quot;@id/rowButtons&quot;&#10;        app:layout_constraintStart_toStartOf=&quot;parent&quot;&#10;        app:layout_constraintEnd_toEndOf=&quot;parent&quot;&#10;        android:layout_marginTop=&quot;12dp&quot; /&gt;&#10;&#10;    &lt;ScrollView&#10;        android:id=&quot;@+id/scroll&quot;&#10;        android:layout_width=&quot;0dp&quot;&#10;        android:layout_height=&quot;0dp&quot;&#10;        android:layout_marginTop=&quot;12dp&quot;&#10;        app:layout_constraintBottom_toBottomOf=&quot;parent&quot;&#10;        app:layout_constraintEnd_toEndOf=&quot;parent&quot;&#10;        app:layout_constraintStart_toStartOf=&quot;parent&quot;&#10;        app:layout_constraintTop_toBottomOf=&quot;@id/progress&quot;&gt;&#10;&#10;        &lt;LinearLayout&#10;            android:id=&quot;@+id/contentContainer&quot;&#10;            android:layout_width=&quot;match_parent&quot;&#10;            android:layout_height=&quot;wrap_content&quot;&#10;            android:orientation=&quot;vertical&quot;&gt;&#10;&#10;            &lt;TextView&#10;                android:id=&quot;@+id/tvOutput&quot;&#10;                android:layout_width=&quot;match_parent&quot;&#10;                android:layout_height=&quot;wrap_content&quot;&#10;                android:text=&quot;Enter a seed and tap Start.&quot;&#10;                android:textSize=&quot;16sp&quot; /&gt;&#10;&#10;            &lt;LinearLayout&#10;                android:id=&quot;@+id/pagesContainer&quot;&#10;                android:layout_width=&quot;match_parent&quot;&#10;                android:layout_height=&quot;wrap_content&quot;&#10;                android:layout_marginTop=&quot;12dp&quot;&#10;                android:orientation=&quot;vertical&quot; /&gt;&#10;&#10;        &lt;/LinearLayout&gt;&#10;&#10;    &lt;/ScrollView&gt;&#10;&#10;&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;&#10;" />
              <option name="updatedContent" value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#10;&lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&#10;    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;&#10;    xmlns:tools=&quot;http://schemas.android.com/tools&quot;&#10;    android:id=&quot;@+id/main_story&quot;&#10;    android:layout_width=&quot;match_parent&quot;&#10;    android:layout_height=&quot;match_parent&quot;&#10;    android:padding=&quot;24dp&quot;&#10;    tools:context=&quot;.StoryModeActivity&quot;&gt;&#10;&#10;    &lt;TextView&#10;        android:id=&quot;@+id/titleStory&quot;&#10;        android:layout_width=&quot;0dp&quot;&#10;        android:layout_height=&quot;wrap_content&quot;&#10;        android:text=&quot;Story mode&quot;&#10;        android:textStyle=&quot;bold&quot;&#10;        android:textSize=&quot;20sp&quot;&#10;        app:layout_constraintTop_toTopOf=&quot;parent&quot;&#10;        app:layout_constraintStart_toStartOf=&quot;parent&quot;&#10;        app:layout_constraintEnd_toEndOf=&quot;parent&quot; /&gt;&#10;&#10;    &lt;EditText&#10;        android:id=&quot;@+id/etSeed&quot;&#10;        android:layout_width=&quot;0dp&quot;&#10;        android:layout_height=&quot;wrap_content&quot;&#10;        android:hint=&quot;Seed prompt (e.g., 'A brave bunny in space')&quot;&#10;        android:inputType=&quot;textCapSentences|textMultiLine&quot;&#10;        android:minLines=&quot;2&quot;&#10;        android:maxLines=&quot;4&quot;&#10;        app:layout_constraintTop_toBottomOf=&quot;@id/titleStory&quot;&#10;        app:layout_constraintStart_toStartOf=&quot;parent&quot;&#10;        app:layout_constraintEnd_toEndOf=&quot;parent&quot;&#10;        android:layout_marginTop=&quot;12dp&quot; /&gt;&#10;&#10;    &lt;LinearLayout&#10;        android:id=&quot;@+id/rowButtons&quot;&#10;        android:layout_width=&quot;0dp&quot;&#10;        android:layout_height=&quot;wrap_content&quot;&#10;        android:orientation=&quot;horizontal&quot;&#10;        app:layout_constraintTop_toBottomOf=&quot;@id/etSeed&quot;&#10;        app:layout_constraintStart_toStartOf=&quot;parent&quot;&#10;        app:layout_constraintEnd_toEndOf=&quot;parent&quot;&#10;        android:layout_marginTop=&quot;12dp&quot;&gt;&#10;&#10;        &lt;Button&#10;            android:id=&quot;@+id/btnStart&quot;&#10;            android:layout_width=&quot;0dp&quot;&#10;            android:layout_height=&quot;wrap_content&quot;&#10;            android:layout_weight=&quot;1&quot;&#10;            android:text=&quot;Start&quot; /&gt;&#10;&#10;        &lt;Button&#10;            android:id=&quot;@+id/btnNext&quot;&#10;            android:layout_width=&quot;0dp&quot;&#10;            android:layout_height=&quot;wrap_content&quot;&#10;            android:layout_weight=&quot;1&quot;&#10;            android:text=&quot;Next&quot;&#10;            android:enabled=&quot;false&quot;&#10;            android:layout_marginStart=&quot;12dp&quot; /&gt;&#10;&#10;    &lt;/LinearLayout&gt;&#10;&#10;    &lt;ScrollView&#10;        android:id=&quot;@+id/scroll&quot;&#10;        android:layout_width=&quot;0dp&quot;&#10;        android:layout_height=&quot;0dp&quot;&#10;        android:layout_marginTop=&quot;12dp&quot;&#10;        app:layout_constraintBottom_toBottomOf=&quot;parent&quot;&#10;        app:layout_constraintEnd_toEndOf=&quot;parent&quot;&#10;        app:layout_constraintStart_toStartOf=&quot;parent&quot;&#10;        app:layout_constraintTop_toBottomOf=&quot;@id/rowButtons&quot;&gt;&#10;&#10;        &lt;LinearLayout&#10;            android:id=&quot;@+id/contentContainer&quot;&#10;            android:layout_width=&quot;match_parent&quot;&#10;            android:layout_height=&quot;wrap_content&quot;&#10;            android:orientation=&quot;vertical&quot;&gt;&#10;&#10;            &lt;LinearLayout&#10;                android:id=&quot;@+id/pagesContainer&quot;&#10;                android:layout_width=&quot;match_parent&quot;&#10;                android:layout_height=&quot;wrap_content&quot;&#10;                android:orientation=&quot;vertical&quot; /&gt;&#10;&#10;        &lt;/LinearLayout&gt;&#10;&#10;    &lt;/ScrollView&gt;&#10;&#10;&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>